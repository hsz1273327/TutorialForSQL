# 收尾

SQL语言大致就介绍完了,下面是一些优化技巧相关的内容.

## 关于查询优化

SQL查询优化一般都还是要看各个数据库管理软件的实现,不过有一些基本的原则一般可以通用:

+ 参数是子查询时使用`EXISTS`代替`IN`,使用`EXISTS`时更快的原因有两个

    1. 如果连接列上建立了索引,那么查询第二张表时不用查实际的表只需查索引就可以了
    2. 如果使用`EXISTS`那么只要查到一行数据满足条件就会终止查询.而使用`IN`时一定会扫全表
    
+ 参数是子查询时使用联结操作代替`IN`.联结操作没有了子查询,所以数据库也不会生成中间表,也就不会遍历全表.

+ 避免排序,排序并不是只有`ORDER BY`语句会执行,其他还有一些语句隐含了排序.排序一定会扫全表所以要谨慎使用,会产生排序的语句包括:
    
    + `GROUP BY`子句
    + `ORDER BY`子句
    + 聚合函数(`SUM/COUNT/AVG/MAX/MIN`)
    + `DISTINCT`
    + 集合运算符(`UNION/INTERSECT/EXCEPT`)
    + 窗口函数(`RANK/ROW_NUMBER`等)

    排序如果只在内存中进行那么还好,但是如果内存不足因而需要在硬盘上排序,那么速度将会非常感人(尤其还不是ssd的话).因此需要尽量避免无谓的排序
    
+ 灵活使用集合运算符的`ALL`可选项.接上条,集合运算符隐含了排序操作,但如果加上`ALL`可选项则不会进行排序,因此追求性能的时候加上`ALL`

+ 使用`EXISTS`代替`DISTINCT`.为了排除重复数据`DISTINCT`也会进行排序.如果需要对两张表的连接结果进行去重可以考虑使用`EXISTS`代替 `DISTINCT`以避免排序.

+ 能写在 WHERE 子句里的条件不要写在 HAVING 子句里

+ 减少中间表

    + 先进行联结再进行聚合
    + 灵活使用`HAVING`子句替代中间表

+ 减少`IN`语句的遍历次数,比如在多处使用`IN`时最好可以将其合并在一起一次遍历
    
+ 合理地使用视图,尽量不在视图中使用聚合函数和集合运算.
    
+ 合理使用索引,索引使用得当可以提高查询速度,具体有这么几个点:

    + 根据需求选择索引类型,这个就要看不同的数据库管理系统的实现了,比如在pg中B-tree可以在可排序数据上的处理等值和范围查询.Hash只能处理简单等值比较.
    + `MAX/MIN`,`GROUP BY`子句和`ORDER BY`中尽量指定有索引的列或者联合索引中在第一列的列作为锚.
    + `WHERE`子句中将运算放在带索引的列一侧,且条件表达式的左侧应该是原始字段
    + 使用联合索引时第一列必须写在查询条件的开头,而且索引中列的顺序不能颠倒
    + 如果无法保证查询条件里列的顺序与索引一致，可以考虑将联合索引拆分为多个索
    + 使用`LIKE`谓词时尽量用前方一致匹配,只有前方一致的匹配才能用到索引
    + 使用显式的类型转换,隐式类型转换会使索引失效
    + 尽量不用`OR`,尽量不用`<>`和`NOT IN`,这些都会使索引失效
